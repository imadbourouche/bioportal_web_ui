#!/usr/bin/env bash
docker compose run --rm rails  bash -c "bundle check || bundle install"  > /dev/null 2>&1

case "$1" in
  "bundle")
    echo "Run: $*"
    docker compose run --rm -it rails bash -c "$*"
    ;;
  "dev")
    echo "Starting development server..."
    echo "Run: bundle exec rails s -b 0.0.0.0"
    docker compose run --rm -it --service-ports rails bash -c "bin/rails db:prepare && bundle exec rails s -b 0.0.0.0"
    ;;
  "test")
    echo "Running API..."
    if ! curl -sSf http://localhost:9393 > /dev/null 2>&1;  then
       if !  bin/run_api; then
            echo "Error: Failed to run a local API"
            exit 1
       fi
    fi


    echo "Running tests..."
    echo "Run: API_URL=http://localhost:9393 bundle exec rails test -v $*"
    docker compose run --rm -it test bash -c "RAILS_ENV=test bin/rails db:prepare && API_URL=http://localhost:9393 bundle exec rails test -v $*"

    echo "Stopping API..."
    bin/stop_api

    ;;
  *)
    echo "Usage: $0 {dev|test|bundle}"
    exit 1
    ;;
esac